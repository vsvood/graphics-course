# Каскадные тени

В данном задании вам предстоит научиться рисовать тени на крупных сценах в реальном времени при помощи техники каскадных теневых карт (cascade shadow maps, CSM).

## Перед началом

1. Скопируйте в эту папку ваш текущий рендерер из предыдущих домашек.
**Важно:** если у вас решена домашка terrain, обязательно используйте её.
Если нет, найдите самостоятельно и загрузите достаточно крупную сцену чтобы использование каскадных теней имело смысл.
Решение без сцены на которой будет видно разные каскады не будет принято.
2. Изучите как рисовать сцену в карту теней смотря на семпл [shadowmap](/samples/shadowmap/), в том числе в рендердоке.
3. Вспомните техники каскадных карт теней.

## Задание

#### Шаг 1

Добавьте в ваш ренедерер отрисовку одной карты теней от солнца с фиксированной ортогональной матрицей проекции по аналогии с семплом [shadowmap](/samples/shadowmap/).

Если вы реализовали поддержку нескольких источников освещения, не забудьте добавить отдельный направленный источник света "солнце", тени от которого мы и будем вычислять.
Для других источников света тени вычисляться не будут.
Если вы используете отложенное освещение, накладывайте тени в момент резолва G-буфера, иначе прямо во время рендеринга сцены.
При этом учитывайте, что в тени не должен учитываться лишь свет от солнца, а свет от других источников должен остаться как есть.

Скорее всего эта карта теней будет меньше чем ваша сцена в мировом пространстве, либо её разрешения не будет хватать чтобы покрыть детали сцены в достаточном разрешении.

#### Шаг 2

Добавьте разбиение фрустума камеры на субфрустумы и вычислите по ним матрицы проекции для каждого каскада, чьи фрустумы покрывают соответствующие субфрустумы основной камеры.
Для выбора стратегии разбиения на фрустумы смотрите раздел "полезные материалы".
Для вычисления матрицы проекции преобразуйте каждую вершину субфрустума в пространство камеры теневого каскада и найдите axis aligned bounding box накрывающий при помощи минимумов и максимумов по всем координатам.

Для дебага рекомендуется прокинуть матрицы проекции каскадов в отрисовку или резолв и закрасить точки поверхности попадающие в соответствующие фрустумы в разные цвета.
Это позволит убедиться что у вас нету "дырок" между каскадами.

#### Шаг 3

Замените одну карту теней на изображение-массив с несколькими слоями соответствующими разным каскадам и отрисуйте сцену в каждую из них при помощи вычисленных ранее матриц проекции.
Делать куллинг при отрисовке теневых каскадов не требуется.

Поменяйте код наложения теней в шейдере чтобы тень бралась из каскада соответствующего текущей точке поверхности.
Не забудьте для этого прокинуть матрицы проекции каскадов в соответствующий шейдер.

## Бонусный уровень

### Вариант 1

Реализуйте технику percentage-closer filtering (PCF) для гладких теней поверх CSM.
Обязательно добавьте наложение фрустумов каскадов друг на друга и гладко смешивайте значение тени в областях попадающих в два соседних каскада чтобы избежать "разрывов" на границах каскадов.

### Вариант 2

Реализуйте фрустум куллинг (можно даже на GPU) для теневых каскадов.
Убедитесь при помощи профайлера, что от добавления куллинга отрисовка действительно стала быстрее.

### Вариант 3

Реализуйте технику VSM для гладких теней поверх CSM.

## Полезные материалы

1. https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=15a9f2a7cf6b1494f45799617c017bd42659d753 &mdash; "Parallel-Split Shadow Maps", одна из возможных стратегий выбора разбиения фрустума на теневые каскады
2. https://dl.acm.org/doi/pdf/10.1145/37401.37435 &mdash; оригинальная статья про PCF
3. https://www-igm.univ-mlv.fr/~biri/Enseignement/MII2/Donnees/variance_shadow_maps.pdf &mdash; оригинальная статья про VSM
4. https://learn.microsoft.com/en-us/windows/win32/dxtecharts/cascaded-shadow-maps &mdash; статья от Майкрософт про CSM, PCF и VSM.
